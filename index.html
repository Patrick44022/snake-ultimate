
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Snake Ultimate++ Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>üêç Snake Ultimate++ by Patrick (v4: Realtime + Fix)</h1>
  <div id="menu">
    <input type="text" id="playerName" placeholder="Dein Name">
    <select id="skinSelect">
      <option value="classic">Classic</option>
      <option value="emoji">Emoji</option>
      <option value="neon">Neon</option>
      <option value="frog">Frog</option>
      <option value="alien">Alien</option>
      <option value="fire">Fire</option>
      <option value="ice">Ice</option>
      <option value="patrick">Patrick</option>
    </select><br><br>
    <button id="startBtn">üéÆ Start</button>
    <button id="musicBtn">üéµ Musik</button>
    <button id="themeBtn">üåó Theme</button><br><br>
    <input type="password" id="adminPass" placeholder="Admin Passwort">
    <button id="adminBtn">üîê Admin</button>
    <div id="adminPanel" style="display:none;">
      <button id="resetBtn">üóëÔ∏è (lokal) Scores l√∂schen</button>
    </div>
  </div>

  <canvas id="game" width="400" height="400"></canvas>
  <div id="leaderboard"><h2>üåç Online Highscores (Live)</h2><ol id="scores"></ol></div>
  <audio id="music" src="music.mp3" loop autoplay></audio>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://cimflibckeqersptrdam.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpbWZsaWJja2VxZXJzcHRyZGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxMzg5NDksImV4cCI6MjA1OTcxNDk0OX0.uHuXcGcaxaQAzpykCShBTp48a2mCaAJ7QUAZLKx2o50";
    const db = createClient(supabaseUrl, supabaseKey);

    let canvas = document.getElementById("game");
    let ctx = canvas.getContext("2d");
    let music = document.getElementById("music");
    let skin = "classic", player = "Gast", score = 0, snake = [], direction = "RIGHT", food = {}, interval;

    function resizeCanvas() {
      if (window.innerWidth <= 600) {
        canvas.style.width = "100vw";
        canvas.style.maxWidth = "100vw";
      } else {
        canvas.style.width = "400px";
        canvas.style.maxWidth = "400px";
      }
    }
    window.addEventListener("resize", resizeCanvas);
    window.onload = () => {
      resizeCanvas();
      updateLeaderboard();
    };

    document.getElementById("startBtn").onclick = () => startGame();
    document.getElementById("musicBtn").onclick = () => toggleMusic();
    document.getElementById("themeBtn").onclick = () => {
      document.body.classList.toggle("dark");
    };
    document.getElementById("adminBtn").onclick = () => {
      const pw = document.getElementById("adminPass").value;
      if (pw === "patrickboss") {
        document.getElementById("adminPanel").style.display = "block";
        alert("üõ°Ô∏è Admin aktiviert!");
      } else alert("‚ùå Falsches Passwort!");
    };
    document.getElementById("resetBtn").onclick = () => {
      localStorage.removeItem("scores");
      updateLeaderboard();
    };

    function startGame() {
      skin = document.getElementById("skinSelect").value;
      player = document.getElementById("playerName").value || "Gast";
      snake = [{x: 200, y: 200}];
      food = {x: Math.floor(Math.random()*20)*20, y: Math.floor(Math.random()*20)*20};
      direction = "RIGHT"; score = 0;
      clearInterval(interval);
      interval = setInterval(gameLoop, 150);
    }

    function drawSegment(s, head=false) {
      ctx.fillStyle = "lime";
      ctx.fillRect(s.x, s.y, 20, 20);
    }

    function gameLoop() {
      ctx.clearRect(0, 0, 400, 400);
      let head = {...snake[0]};
      if (direction === "RIGHT") head.x += 20;
      if (direction === "LEFT") head.x -= 20;
      if (direction === "UP") head.y -= 20;
      if (direction === "DOWN") head.y += 20;
      if (head.x < 0 || head.x >= 400 || head.y < 0 || head.y >= 400 || snake.some(s => s.x === head.x && s.y === head.y)) {
        clearInterval(interval);
        alert("Game Over! Punkte: " + score);
        saveScore();
        return;
      }
      snake.unshift(head);
      if (head.x === food.x && head.y === food.y) {
        score++;
        food = {x: Math.floor(Math.random()*20)*20, y: Math.floor(Math.random()*20)*20};
      } else {
        snake.pop();
      }
      snake.forEach((s, i) => drawSegment(s, i===0));
      ctx.fillStyle = "red";
      ctx.fillRect(food.x, food.y, 20, 20);
    }

    document.addEventListener("keydown", e => {
      if (e.key === "ArrowUp" && direction !== "DOWN") direction = "UP";
      if (e.key === "ArrowDown" && direction !== "UP") direction = "DOWN";
      if (e.key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
      if (e.key === "ArrowRight" && direction !== "LEFT") direction = "RIGHT";
    });

    canvas.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    canvas.addEventListener("touchmove", e => {
      e.preventDefault();
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 0 && direction !== "LEFT") direction = "RIGHT";
        else if (dx < 0 && direction !== "RIGHT") direction = "LEFT";
      } else {
        if (dy > 0 && direction !== "UP") direction = "DOWN";
        else if (dy < 0 && direction !== "DOWN") direction = "UP";
      }
    }, { passive: false });

    function toggleMusic() {
      music.paused ? music.play() : music.pause();
    }

    async function saveScore() {
      const { error } = await db.from('highscores').insert([
        { player_name: player, score: score }
      ]);
      if (error) {
        alert("‚ùå Fehler beim Speichern!");
        console.error("Supabase error:", error);
      } else {
        updateLeaderboard();
      }
    }

    async function updateLeaderboard() {
      const list = document.getElementById("scores");
      list.innerHTML = "";
      const { data, error } = await db.from('highscores').select("*").order('score', { ascending: false }).limit(10);
      if (data) {
        data.forEach(e => {
          const li = document.createElement("li");
          li.textContent = `${e.player_name}: ${e.score}`;
          list.appendChild(li);
        });
      }
    }

    // Realtime-Updater
    db.channel('realtime:scores')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'highscores' }, payload => {
        console.log("Neuer Score eingegangen!");
        updateLeaderboard();
      }).subscribe();

  </script>
</body>
</html>
